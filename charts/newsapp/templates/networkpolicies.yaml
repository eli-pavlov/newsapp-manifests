{{- /*
Minimal lock-down:
- Default deny (ingress+egress) for all pods in this namespace
- Allow DNS egress to CoreDNS
- Allow ingress-nginx -> frontend :8080
- Allow frontend -> backend :8080
- Allow backend -> postgres :5432
- Allow postgres <- backend :5432
- Optional: Allow backend -> public internet :80/:443 (opt-in via values)

NOTE: Effective only with a NetworkPolicy-aware CNI (e.g., Cilium/Calico).
*/ -}}
{{- $np := .Values.networkPolicy | default dict -}}
{{- $beeg := $np.backendEgressWeb | default dict -}}
{{- if $np.enabled }}

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  annotations:
    # Apply early but after namespace creation
    argocd.argoproj.io/sync-wave: "1"
spec:
  podSelector: {}
  policyTypes: ["Ingress","Egress"]

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
spec:
  podSelector: {}
  policyTypes: ["Egress"]
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: coredns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# Ingress from ingress-nginx -> frontend on 8080
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: fe-allow-from-ingress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: frontend
  policyTypes: ["Ingress"]
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080

---
# FE -> BE egress on 8080
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: fe-egress-be
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: frontend
  policyTypes: ["Egress"]
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: backend
      ports:
        - protocol: TCP
          port: 8080

---
# BE <- FE ingress on 8080
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: be-ingress-from-fe
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: backend
  policyTypes: ["Ingress"]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: frontend
      ports:
        - protocol: TCP
          port: 8080

{{- if and $beeg.enabled }}
---
# (Opt-in) BE -> public internet on 80/443; exclude RFC1918/Carrier-Grade NAT.
# DB/cluster internal access remains covered by other policies.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: be-egress-web
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: backend
  policyTypes: ["Egress"]
  egress:
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            {{- if $beeg.exceptCidrs }}
            except:
            {{- range $cidr := $beeg.exceptCidrs }}
              - {{ $cidr | quote }}
            {{- end }}
            {{- end }}
      ports:
      {{- range $p := ($beeg.ports | default (list 80 443)) }}
        - protocol: TCP
          port: {{ $p }}
      {{- end }}
{{- end }}

{{- if .Values.db.enabled }}
---
# BE -> DB egress on 5432
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: be-egress-db
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: backend
  policyTypes: ["Egress"]
  egress:
    - to:
        - podSelector:
            matchLabels:
              # postgres chart labels pods with app.kubernetes.io/name: <service.name or chart name>
              app.kubernetes.io/name: {{ .Values.db.service.name | default "postgresql" | quote }}
      ports:
        - protocol: TCP
          port: {{ .Values.db.service.port | default 5432 }}

---
# DB <- BE ingress on 5432
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: db-ingress-from-be
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ .Values.db.service.name | default "postgresql" | quote }}
  policyTypes: ["Ingress"]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: backend
      ports:
        - protocol: TCP
          port: {{ .Values.db.service.port | default 5432 }}
{{- end }}

{{- end }}

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-acme-http01
spec:
  podSelector:
    matchLabels:
      acme.cert-manager.io/http01-solver: "true"
  policyTypes: ["Ingress"]
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8089
